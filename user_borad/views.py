from urllib import request

from celery import shared_task
from django.contrib.auth import authenticate
from django.shortcuts import render, redirect
from requests import auth

import Let.models
import user_borad
from user_borad import models
from user_borad import tasks
from Let import models as LetModle



#邮件发件测试
from django.core.mail import send_mail
def send_email(request):
    send_mail(
        subject='测试网站标题',
        message='测试网站内容',
        from_email='watch.dog@qq.com',
        recipient_list=['watch.dog@qq.com'],
        fail_silently=False
    )
    return request('OK')


def user_reg(request):
    email_cod = []
    if request.method == 'GET':
        return render(request, 'index_page/user/user_reg.html')
    if request.method == 'POST':
        # import random
        # str1 = '0123456789'
        # rand_str = ''
        # for i in range(0, 6):
        #     rand_str += str1[random.randrange(0, len(str1))]

        rename = request.POST.get('Rname')
        username = request.POST.get('name')
        password = request.POST.get('password')
        email = request.POST.get('email')

        Pbbool = models.user.objects.filter(username=username).exists()##用户是否存在数据库中---验证
        if Pbbool:
            x = ('该用户已经存在')
            return render(request, 'index_page/user/user_reg.html', {'x':x})
        else:
            import random
            str1 = '0123456789'
            rand_str = ''
            for i in range(0, 6):
                rand_str += str1[random.randrange(0, len(str1))]
            models.user.objects.create(user_Rename=rename, username=username, password=password, useremail=email,
                                       user_acict_code=rand_str,user_acict_statu=0)
            # send_mail(
            #          subject='Avnext网站验证码',
            #          message='你的验证码为:'+ rand_str +'请不要将你的验证码告诉其他人',
            #          from_email='watch.dog@qq.com',
            #          recipient_list= [email] ,
            #          fail_silently=False)
            #此处给task，发送邮件任务传递两个参数，一个参数为；用户的EMAIL，一个参数为当前生产的ID
            testmail = tasks.send_email.delay(email,rand_str=rand_str)
            return  redirect('/user/user_code/')




def user_login(request):
    if request.method == 'GET':
        return render(request, 'index_page/user/user_login.html')
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        try:
            if models.user.objects.get(username=username):
                if models.user.objects.get(password=password):
                    request.session['username'] = username
                    request.session.set_expiry(600)
                    x = LetModle.elet.objects.all()
                    return redirect('/app/index/',{'x':x})
                else:
                    pass
            else:
                x = '对不起用户或者密码错误'
                return  render(request, 'index_page/user/user_login.html', {'x':x})
        except:
            x = '对不起用户或者密码错误'
            return render(request, 'index_page/user/user_login.html', {'x':x})




#此处为验证码对应用户ID验证,验证码反查个人的用户名,然后使用save保存指定字段.将账号变成激活状态
def user_code(request):
    if request.method == 'GET':
        return render(request, 'index_page/user/user_code.html')
    elif request.method == 'POST':
        email_stat_cod = request.POST.get('email_code')
        test_mail = models.user.objects.filter(user_acict_code=email_stat_cod) ##此处对比查找和激活码相对应的ID
        if test_mail:#如果查找到了激活码那么进入下面的循环
            for record in test_mail:
                x = models.user.objects.get(username=record.username)
                x.user_acict_statu = 1#将激活状态改成1
                x.save()#数据库保存
                return redirect('http://127.0.0.1:8000/app/index/')
        else:
                x = '对不起，验证码错误请重试'
                return render(request, 'index_page/user/user_code.html', {'x':x})
